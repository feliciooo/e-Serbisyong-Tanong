<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Reset Password - e-Serbisyong Tañong</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,500,600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    
    
</head>
<body class="min-h-screen m-0 font-['Roboto',Arial,sans-serif] bg-gray-50">
    <div class="flex min-h-screen">
        <!-- Left: Barangay image -->
        <div class="hidden md:flex w-2/3 bg-cover bg-center relative" style="background-image:url('BarangayHall.jpg')">
            <div class="flex flex-col justify-center items-center w-full h-full bg-black bg-opacity-40 z-10">
            </div>
            <div class="absolute top-0 right-0 h-full w-24 bg-gradient-to-r from-transparent to-white z-20 pointer-events-none"></div>
        </div>
        <!-- Right: Reset form -->
        <div class="flex w-full md:w-1/2 items-center justify-center md:justify-end px-4 md:px-16 bg-white">
            <div id="card" class="bg-white px-8 py-10 rounded-2xl shadow-2xl w-full max-w-sm flex flex-col items-center slide-in-right">
                <!-- Logo and Title -->
                <div class="flex flex-col items-center mb-6">
                    <img src="icon.png" alt="Logo" class="w-16 h-16 mb-2 rounded-full shadow-md object-cover">
                    <span class="text-xl font-bold text-orange-500 tracking-wide">e-Serbisyong Tañong</span>
                </div>
                <h2 id="cardTitle" class="mb-6 font-semibold text-gray-900 text-2xl tracking-wide">Reset Password</h2>

                <!-- Request reset (shown when no oobCode) -->
                <form id="requestResetForm" class="w-full hidden">
                    <div class="mb-5 w-full">
                        <label for="requestEmail" class="block mb-2 text-base text-gray-700 font-medium">Email Address</label>
                        <input type="email" id="requestEmail" placeholder="Enter your email" required
                               class="w-full px-4 py-3 border border-gray-200 rounded-lg text-base bg-gray-50 focus:border-orange-400 focus:bg-white outline-none transition" />
                    </div>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <button type="submit" class="flex-1 px-4 py-3 rounded-lg bg-orange-400 text-white font-semibold text-base transition hover:bg-orange-300">Send reset link</button>
                        <button type="button" class="flex-1 px-4 py-3 rounded-lg bg-gray-50 text-orange-400 border border-orange-200 font-semibold text-base transition hover:bg-orange-50" onclick="window.location.href='Login.html'">Back</button>
                    </div>
                </form>

                <!-- Confirm reset (shown when oobCode exists) -->
                <form id="confirmResetForm" class="w-full hidden">
                    <div class="mb-3 w-full">
                        <label for="resetEmail" class="block mb-2 text-sm text-gray-700 font-medium">Account</label>
                        <input type="email" id="resetEmail" readonly class="w-full px-4 py-3 border border-gray-200 rounded-lg text-base bg-gray-100 outline-none" />
                    </div>
                    <div class="mb-3 w-full">
                        <label for="newPassword" class="block mb-2 text-sm text-gray-700 font-medium">New password</label>
                        <input type="password" id="newPassword" placeholder="Enter new password" required class="w-full px-4 py-3 border border-gray-200 rounded-lg text-base bg-white focus:border-orange-400 outline-none" />
                    </div>
                    <div class="mb-3 w-full">
                        <label for="confirmPassword" class="block mb-2 text-sm text-gray-700 font-medium">Confirm new password</label>
                        <input type="password" id="confirmPassword" placeholder="Confirm new password" required class="w-full px-4 py-3 border border-gray-200 rounded-lg text-base bg-white focus:border-orange-400 outline-none" />
                    </div>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <button type="submit" class="flex-1 px-4 py-3 rounded-lg bg-orange-400 text-white font-semibold text-base transition hover:bg-orange-300">Set password</button>
                        <button type="button" class="flex-1 px-4 py-3 rounded-lg bg-gray-50 text-orange-400 border border-orange-200 font-semibold text-base transition hover:bg-orange-50" onclick="window.location.href='Login.html'">Cancel</button>
                    </div>
                </form>

                <div id="statusMsg" class="text-sm mt-4 text-center"></div>
            </div>
        </div>
    </div>
    <style>
        .slide-in-right {
            transform: translateX(80px);
            opacity: 0;
            animation: slideInRight 0.7s cubic-bezier(.68,-0.55,.27,1.55) forwards;
        }
        @keyframes slideInRight {
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>

    <script>
        // Firebase config (already included in your script)
        const firebaseConfig = {
        apiKey: "AIzaSyCDT65vncku1avdYSxrCJCM_SE-gN2E2ok",
        authDomain: "e-serbisyong-tanong.firebaseapp.com",
        databaseURL: "https://e-serbisyong-tanong-default-rtdb.firebaseio.com",
        projectId: "e-serbisyong-tanong",
        storageBucket: "e-serbisyong-tanong.firebasestorage.app",
        messagingSenderId: "147646033817",
        appId: "1:147646033817:web:503ac4767a4774a4afad08",
        measurementId: "G-3TDQYZTF1H"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        const requestForm = document.getElementById('requestResetForm');
        const confirmForm = document.getElementById('confirmResetForm');
        const statusMsg = document.getElementById('statusMsg');
        const cardTitle = document.getElementById('cardTitle');

        function showStatus(text, color = 'text-red-600') {
            statusMsg.className = 'text-sm mt-4 text-center ' + color;
            statusMsg.textContent = text;
        }

        const params = new URLSearchParams(window.location.search);
        const oobCode = params.get('oobCode');

        if (oobCode) {
            cardTitle.textContent = 'Set New Password';
            confirmForm.classList.remove('hidden');
        } else {
            cardTitle.textContent = 'Reset Password';
            requestForm.classList.remove('hidden');
        }

        requestForm.addEventListener('submit', async function (e) {
            e.preventDefault();
            const email = document.getElementById('requestEmail').value.trim();

            if (!email) {
                showStatus('Please enter your email.', 'text-red-600');
                return;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showStatus('Please enter a valid email address.', 'text-red-600');
                return;
            }

            showStatus('Checking if email is registered...', 'text-gray-700');

            try {
                // Check if the email exists in the Firebase Realtime Database
                const db = firebase.database();
                const snapshot = await db.ref('users').orderByChild('email').equalTo(email).once('value');

                if (!snapshot.exists()) {
                    showStatus('This is not an existing email. Please enter a registered email address.', 'text-red-600');
                    return;
                }

                // Cooldown logic
                const lastRequestTime = localStorage.getItem('lastPasswordResetTime');
                const currentTime = Date.now();
                const cooldownPeriod = 3 * 60 * 1000; // 3 minutes in milliseconds

                if (lastRequestTime && currentTime - lastRequestTime < cooldownPeriod) {
                    const remainingTime = Math.ceil((cooldownPeriod - (currentTime - lastRequestTime)) / 1000);
                    showStatus(`Please wait ${remainingTime} seconds before requesting another reset email.`, 'text-red-600');
                    return;
                }

                showStatus('Sending password reset email...', 'text-gray-700');

                // Send the password reset email
                await auth.sendPasswordResetEmail(email);
                showStatus('Password reset email sent. Check your inbox (and spam folder).', 'text-green-600');

                // Save the current time to localStorage
                localStorage.setItem('lastPasswordResetTime', currentTime);
            } catch (error) {
                console.error('Error sending password reset email:', error);
                let msg = 'An error occurred. Please try again later.';
                if (error.code === 'auth/user-not-found') {
                    msg = 'Email is not registered.';
                } else if (error.code === 'auth/invalid-email') {
                    msg = 'Invalid email address.';
                }
                showStatus(msg, 'text-red-600');
            }
        });

        confirmForm.addEventListener('submit', async function (e) {
            e.preventDefault();
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!newPassword || !confirmPassword) {
                showStatus('Please fill out both password fields.', 'text-red-600');
                return;
            }
            if (newPassword.length < 6) {
                showStatus('Password should be at least 6 characters.', 'text-red-600');
                return;
            }
            if (newPassword !== confirmPassword) {
                showStatus('Passwords do not match.', 'text-red-600');
                return;
            }

            showStatus('Updating password...', 'text-gray-700');

            try {
                await auth.confirmPasswordReset(oobCode, newPassword);
                showStatus('Password has been reset. You can now sign in.', 'text-green-600');
                setTimeout(() => window.location.href = 'Login.html', 2000);
            } catch (error) {
                console.error('Error confirming password reset:', error);
                let msg = 'Unable to reset password. The link may be invalid or expired.';
                if (error.code === 'auth/weak-password') {
                    msg = 'The new password is too weak.';
                }
                showStatus(msg, 'text-red-600');
            }
        });
    </script>
    </body>
    </html>