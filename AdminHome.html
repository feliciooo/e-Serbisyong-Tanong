<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Admin Dashboard - e-Serbisyong Ta√±ong</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="icon.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #fff5e6 0%, #ffe4b3 100%);
            min-height: 100vh;
            color: #1a202c;
        }

        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        /* Replace the existing .navbar-content rule with this centered layout */
        .navbar-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            position: relative; /* allow absolute centering of middle group */
            padding: 0 1rem;
        }

        .nav-left { flex: 0 0 auto; }
        .nav-center {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
        }
        .nav-right { margin-left: auto; display: flex; align-items: center; gap: 1rem; }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #ff9f40 0%, #ffb366 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .nav-link {
            text-decoration: none;
            color: #4a5568;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.3s;
        }

        .nav-link:hover, .nav-link.active {
            background: linear-gradient(135deg, #ffb366 0%, #ffc285 100%);
            color: white;
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-info {
            text-align: right;
        }

        .user-name {
            font-weight: 600;
            color: #2d3748;
        }

        .user-role {
            font-size: 0.85rem;
            color: #718096;
        }

        .logout-btn {
            background: linear-gradient(135deg, #f56565 0%, #c53030 100%);
            color: white;
            border: none;
            padding: 0.6rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 101, 101, 0.4);
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .dashboard-header {
            color: rgb(0, 0, 0);
            margin-bottom: 2rem;
        }

        .dashboard-header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .dashboard-header p {
            opacity: 0.9;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
            cursor: pointer;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .stat-card.users .stat-icon {
            background: linear-gradient(135deg, #ffd199 0%, #ffe0b3 100%);
            color: #d97706;
        }

        .stat-card.services .stat-icon {
            background: linear-gradient(135deg, #ffddb3 0%, #ffead4 100%);
            color: #ea580c;
        }

        .stat-card.news .stat-icon {
            background: linear-gradient(135deg, #ffe9cc 0%, #fff2e0 100%);
            color: #f59e0b;
        }

        .stat-card.pending .stat-icon {
            background: linear-gradient(135deg, #ffc285 0%, #ffd6a5 100%);
            color: #c2410c;
        }

        .stat-card.seniors .stat-icon {
            background: linear-gradient(135deg, #ffe0e0 0%, #ffd6d6 100%);
            color: #c53030;
        }

        .stat-card.adults .stat-icon {
            background: linear-gradient(135deg, #e0ffe0 0%, #d6ffd6 100%);
            color: #2f855a;
        }

        .stat-card.youth .stat-icon {
            background: linear-gradient(135deg, #e0f7ff 0%, #d6f0ff 100%);
            color: #3182ce;
        }

        .stat-card.nearing18 .stat-icon {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            color: #4338ca;
        }

        .stat-card.nearingSenior .stat-icon {
            background: linear-gradient(135deg, #ffe4e6 0%, #fecdd3 100%);
            color: #be185d;
        }

        .stat-card.verification .stat-icon {
            background: linear-gradient(135deg, #d1e7dd 0%, #c3e6cb 100%);
            color: #155724;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            color: #718096;
            font-size: 0.95rem;
            font-weight: 500;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .card {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
        }

        .add-btn {
            background: linear-gradient(135deg, #ffb366 0%, #ffc285 100%);
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 179, 102, 0.4);
        }

        .news-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .news-item {
            border: 2px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1rem;
            transition: all 0.3s;
            cursor: pointer;
        }

        .news-item:hover {
            border-color: #ffb366;
            box-shadow: 0 4px 12px rgba(255, 179, 102, 0.2);
        }

        .news-item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.5rem;
        }

        .news-headline {
            font-weight: 600;
            color: #2d3748;
            font-size: 1.1rem;
        }

        .news-date {
            color: #718096;
            font-size: 0.85rem;
        }

        .news-description {
            color: #4a5568;
            font-size: 0.95rem;
            line-height: 1.5;
            margin-bottom: 0.5rem;
        }

        .news-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-edit, .btn-delete {
            padding: 0.4rem 1rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-edit {
            background: #edf2f7;
            color: #4a5568;
        }

        .btn-edit:hover {
            background: #e2e8f0;
        }

        .btn-delete {
            background: #fed7d7;
            color: #c53030;
        }

        .btn-delete:hover {
            background: #fc8181;
            color: white;
        }

        .activity-feed {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-height: 600px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            background: #f7fafc;
            border-radius: 0.75rem;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .activity-icon.success {
            background: #d1f4e0;
            color: #059669;
        }

        .activity-icon.info {
            background: #ffe9cc;
            color: #ea580c;
        }

        .activity-icon.warning {
            background: #fff4e6;
            color: #f59e0b;
        }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 0.25rem;
        }

        .activity-time {
            color: #718096;
            font-size: 0.85rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: #2d3748;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #718096;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: #f7fafc;
            color: #2d3748;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 0.5rem;
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            font-family: inherit;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: #ffb366;
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-file {
            margin-top: 0.5rem;
        }

        .image-preview {
            margin-top: 1rem;
            border-radius: 0.5rem;
            max-width: 100%;
            max-height: 300px;
            object-fit: cover;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ffb366 0%, #ffc285 100%);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s;
            width: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 179, 102, 0.4);
        }

        .modal-user-list {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-user-list-content {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-user-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-user-list-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
        }

        .modal-user-list-close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #718096;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }

        .modal-user-list-close-btn:hover {
            background: #f7fafc;
            color: #2d3748;
        }

        .user-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .user-list-item {
            padding: 0.75rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .user-list-item:hover {
            border-color: #ffb366;
            background: #fffaf0;
        }

        @media (max-width: 1024px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .navbar-content {
                flex-direction: column;
                gap: 1rem;
            }

            .nav-links {
                gap: 1rem;
            }

            .dashboard-header h1 {
                font-size: 2rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: white;
            border-radius: 0.5rem;
            padding: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast.hide {
            opacity: 0;
            transform: translateY(-10px);
        }

        .toast-icon {
            font-size: 1.5rem;
        }

        .toast.success {
            border-left: 4px solid #38a169;
        }

        .toast.error {
            border-left: 4px solid #e53e3e;
        }

        /* Delete User Modal */
        #deleteUserModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        #deleteUserModal .modal-content {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        #deleteUserModal h2 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        #deleteUserModal p {
            margin-bottom: 1rem;
            color: #4a5568;
        }

        #deleteUserModal textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            font-family: inherit;
            font-size: 1rem;
            transition: border-color 0.2s;
            margin-bottom: 1rem;
        }

        #deleteUserModal textarea:focus {
            outline: none;
            border-color: #ffb366;
        }

        #deleteUserModal .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        #deleteUserModal .btn:hover {
            transform: translateY(-2px);
        }

        #deleteUserModal .btn-cancel {
            background: #edf2f7;
            color: #4a5568;
        }

        #deleteUserModal .btn-confirm {
            background: #e53e3e;
            color: white;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-content">
            <div class="nav-left">
                <div class="logo">e-Serbisyong Ta√±ong</div>
            </div>

            <div class="nav-center">
                <div class="nav-links">
                    <a href="AdminHome.html" class="nav-link active">Dashboard</a>
                    <a href="AdminServices.html" class="nav-link">Services</a>
                    <a href="AdminUsers.html" class="nav-link">Users</a>
                    <a href="UserVerification.html" class="nav-link">User Verification</a>
                    <a href="AdminManagement.html" class="nav-link">Admin Management</a>
                </div>
            </div>

            <div class="nav-right">
                <div class="user-section">
                    <div class="user-info">
                        <div class="user-name" id="userName">Admin</div>
                        <div class="user-role">Administrator</div>
                    </div>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1>Admin Dashboard</h1>
            <p>Manage your barangay services and keep residents informed</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card users" onclick="window.location.href='AdminUsers.html'">
                <div class="stat-icon">üë•</div>
                <div class="stat-value" id="totalUsers">0</div>
                <div class="stat-label">Registered Users</div>
            </div>
            <div class="stat-card services" onclick="window.location.href='AdminServices.html'">
                <div class="stat-icon">üìã</div>
                <div class="stat-value" id="totalRequests">0</div>
                <div class="stat-label">Total Requests</div>
            </div>
            <div class="stat-card news">
                <div class="stat-icon">üì∞</div>
                <div class="stat-value" id="totalNews">0</div>
                <div class="stat-label">News Articles</div>
            </div>
            <div class="stat-card pending" onclick="window.location.href='AdminServices.html?filter=Pending'">
                <div class="stat-icon">‚è≥</div>
                <div class="stat-value" id="pendingRequests">0</div>
                <div class="stat-label">Pending Requests</div>
            </div>
            <div class="stat-card nearing18" onclick="openUserListModal('nearing18')">
                <div class="stat-icon">üßë‚Äçüéì</div>
                <div class="stat-value" id="nearing18Count">0</div>
                <div class="stat-label">Nearing Potential Voters (Age 18)</div>
            </div>
            <div class="stat-card nearingSenior" onclick="openUserListModal('nearingSenior')">
                <div class="stat-icon">üßì</div>
                <div class="stat-value" id="nearingSeniorCount">0</div>
                <div class="stat-label">Nearing Senior Citizens (Age 60)</div>
            </div>
            <div class="stat-card verification" onclick="window.location.href='UserVerification.html?filter=Verification'">
                <div class="stat-icon">üîç</div>
                <div class="stat-value" id="usersForVerification">0</div>
                <div class="stat-label">Users for Verification</div>
            </div>
        </div>

        <div class="content-grid">
          <div class="card" style="margin: 0 auto; max-width: 800px;">
            <div class="card-header">
                <h2 class="card-title">Barangay News</h2>
                <button class="add-btn" onclick="openAddNewsModal()">+ Add News</button>
            </div>
            <div class="news-list" id="newsList">
                <!-- News items will be loaded here -->
            </div>
          </div>
        </div>

            </div>
        </div>
    </div>

    <!-- Add/Edit News Modal -->
    <div class="modal" id="newsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Add News</h3>
                <button class="close-btn" onclick="closeNewsModal()">&times;</button>
            </div>
            <form id="newsForm">
                <div class="form-group">
                    <label class="form-label">Headline</label>
                    <input type="text" class="form-input" id="newsHeadline" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-input" id="newsDate" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" id="newsDescription" required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Image (Optional)</label>
                    <input type="file" class="form-file" id="newsImage" accept="image/*">
                    <img id="imagePreview" class="image-preview" style="display: none;">
                </div>
                <button type="submit" class="btn-primary">Save News</button>
            </form>
        </div>
    </div>

    <!-- User List Modal -->
    <div class="modal-user-list" id="userListModal">
        <div class="modal-user-list-content">
            <div class="modal-user-list-header">
                <h3 class="modal-user-list-title" id="userListModalTitle">User List</h3>
                <button class="modal-user-list-close-btn" onclick="closeUserListModal()">&times;</button>
            </div>
            <ul class="user-list" id="userListContent">
                <!-- User list items will be dynamically added here -->
            </ul>
        </div>
    </div>

    <!-- Delete User Modal -->
    <div id="deleteUserModal" class="modal hidden">
        <div class="modal-content max-w-md">
            <h2 class="text-lg font-bold mb-4">Delete User Account</h2>
            <p class="mb-4">Reason for deletion of this account:</p>
            <textarea id="deleteReasonInput" class="w-full border border-gray-300 rounded p-2 mb-4" rows="3" placeholder="Enter reason..."></textarea>
            <div class="flex justify-end gap-2">
                <button id="cancelDeleteUserBtn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400">Cancel</button>
                <button id="confirmDeleteUserBtn" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-500">Delete</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script>
        const firebaseConfig = {
        apiKey: "AIzaSyCDT65vncku1avdYSxrCJCM_SE-gN2E2ok",
        authDomain: "e-serbisyong-tanong.firebaseapp.com",
        databaseURL: "https://e-serbisyong-tanong-default-rtdb.firebaseio.com",
        projectId: "e-serbisyong-tanong",
        storageBucket: "e-serbisyong-tanong.firebasestorage.app",
        messagingSenderId: "147646033817",
        appId: "1:147646033817:web:503ac4767a4774a4afad08",
        measurementId: "G-3TDQYZTF1H"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        // alias for compatibility with other admin pages that expect `db`
        const db = database;
        const auth = firebase.auth();

        // Live admin-access watcher: forces sign-out+redirect when access !== 'full'
        window._adminAccessRef = window._adminAccessRef || null;
        async function watchAdminAccess() {
            // detach previous listener
            try { if (window._adminAccessRef) { window._adminAccessRef.off(); window._adminAccessRef = null; } } catch(e) {}
            const user = auth.currentUser;
            if (!user) return;

            const attach = (ref) => {
                if (!ref) return;
                window._adminAccessRef = ref;
                ref.on('value', snap => {
                    const rec = snap && snap.val() ? snap.val() : null;
                    const access = rec && (rec.access || rec.role) ? String(rec.access || rec.role).toLowerCase() : null;
                    if (access !== 'full') {
                        try { if (window._adminAccessRef) { window._adminAccessRef.off(); window._adminAccessRef = null; } } catch(e) {}
                        console.warn('Admin access revoked or not full ‚Äî signing out', { access });
                        auth.signOut().finally(() => { window.location.href = 'Login.html'; });
                    } else {
                        // keep UI in sync
                        window.currentAdminAccess = 'full';
                        if (typeof applyAdminAccessUI === 'function') applyAdminAccessUI();
                    }
                }, err => console.error('admin access watch error', err));
            };

            try {
                // 1) direct node admins/{uid}
                const directRef = db.ref('admins/' + user.uid);
                const directSnap = await directRef.once('value');
                if (directSnap && directSnap.exists()) { attach(directRef); return; }

                // 2) fallback: admins entries with child 'uid'
                const byUidSnap = await db.ref('admins').orderByChild('uid').equalTo(user.uid).limitToFirst(1).once('value');
                if (byUidSnap && byUidSnap.exists()) {
                    const key = Object.keys(byUidSnap.val())[0];
                    attach(db.ref('admins/' + key));
                    return;
                }

                // 3) fallback: search by email (case-insensitive)
                const emailKey = (user.email || '').toLowerCase();
                const byEmailSnap = await db.ref('admins').orderByChild('email').equalTo(emailKey).limitToFirst(1).once('value');
                if (byEmailSnap && byEmailSnap.exists()) {
                    const key = Object.keys(byEmailSnap.val())[0];
                    attach(db.ref('admins/' + key));
                    return;
                }

                // no admin record -> sign out
                console.warn('No admin DB record for signed-in user ‚Äî signing out');
                await auth.signOut();
                window.location.href = 'Login.html';
            } catch (err) {
                console.error('watchAdminAccess error', err);
            }
        }

        let newsData = [];
        let currentEditId = null;

        // ...existing code...
function loadCurrentAdminAndApply() {
  window.currentAdminAccess = null; // 'full' | 'limited' | null
  const user = firebase.auth().currentUser;
  if (!user) {
    applyAdminAccessUI();
    return;
  }

  // Attempt to read admins/{uid} first; fallback search by email if needed
  const uidRef = db.ref('admins/' + user.uid);
  uidRef.once('value').then(snap => {
    if (snap.exists()) {
      const data = snap.val();
      window.currentAdminAccess = data.access || 'limited';
      applyAdminAccessUI();
    } else {
      // fallback: search for admin record with same email (if you used push-id)
      db.ref('admins').orderByChild('email').equalTo((user.email||'').toLowerCase()).limitToFirst(1).once('value')
        .then(snap2 => {
          const val = snap2.val();
          if (val) {
            const entry = Object.values(val)[0];
            window.currentAdminAccess = (entry && entry.access) || 'limited';
          } else {
            window.currentAdminAccess = null;
          }
          applyAdminAccessUI();
        })
        .catch(() => { window.currentAdminAccess = null; applyAdminAccessUI(); });
    }
  }).catch(err => { console.error('admin load error', err); window.currentAdminAccess = null; applyAdminAccessUI(); });
}

// Apply UI rules (customize per page)
function applyAdminAccessUI() {
  const access = window.currentAdminAccess;
  // AdminManagement: only full can add/edit/remove admins
  document.querySelectorAll('.admin-add-action').forEach(el => {
    if (access !== 'full') el.style.display = 'none';
    else el.style.display = '';
  });
  // Service archive/remove: only full can archive
  document.querySelectorAll('.archive-action').forEach(el => {
    if (access !== 'full') el.style.display = 'none';
    else el.style.display = '';
  });
  // Removing users (AdminUsers) - only full
  document.querySelectorAll('.remove-user-action').forEach(el => {
    if (access !== 'full') el.style.display = 'none';
    else el.style.display = '';
  });

  // For buttons that should still be visible but disabled for limited:
  document.querySelectorAll('.admin-edit-action').forEach(btn => {
    btn.disabled = (access !== 'full');
  });
}
// run after auth ready
firebase.auth().onAuthStateChanged(user => {
  loadCurrentAdminAndApply();
});
        auth.onAuthStateChanged((user) => {
            if (user) {
                document.getElementById('userName').textContent = user.displayName || 'Admin';
                loadCurrentAdminAndApply();
                // start live enforcement watcher for admin access
                watchAdminAccess();
                fetchStatistics();
                fetchNews();
                fetchRecentActivity();
            } else {
                window.location.href = 'login.html';
            }
        });
        // Fetch and display statistics
        function fetchStatistics() {
            database.ref('users').on('value', (snapshot) => {
                const users = snapshot.val() || {};
                let total = 0, nearing18 = [], nearingSenior = [], forVerification = 0;

                Object.values(users).forEach(user => {
                    total++;
                    const age = parseInt(user.age, 10);
                    if (!isNaN(age)) {
                        if (age >= 16 && age < 18) nearing18.push(user);
                        if (age >= 58 && age < 60) nearingSenior.push(user);
                    }
                    if (user.verificationStatus === 'Pending') {
                        forVerification++;
                    }
                });

                document.getElementById('totalUsers').textContent = total;
                document.getElementById('nearing18Count').textContent = nearing18.length;
                document.getElementById('nearingSeniorCount').textContent = nearingSenior.length;
                // we still set usersForVerification from users node as a fallback
                const usersForVerificationEl = document.getElementById('usersForVerification');
                if (usersForVerificationEl && usersForVerificationEl.textContent === '') {
                    usersForVerificationEl.textContent = forVerification;
                }

                // Store the lists for modal display
                window.nearing18Users = nearing18;
                window.nearingSeniorUsers = nearingSenior;
            });

            // Listen to separate userVerification node (if you store pending verifications there)
            database.ref('userVerification').on('value', (snapshot) => {
                const count = snapshot ? snapshot.numChildren() : 0;
                const el = document.getElementById('usersForVerification');
                if (el) el.textContent = count;
            });

            database.ref('news').on('value', (snapshot) => {
                const count = snapshot.numChildren();
                document.getElementById('totalNews').textContent = count;
            });
        }

        // Fetch news from Firebase
        function fetchNews() {
            database.ref('news').on('value', (snapshot) => {
                newsData = [];
                const data = snapshot.val();

                if (data) {
                    Object.keys(data).reverse().forEach((key) => { // Reverse order for FILO
                        newsData.push({ id: key, ...data[key] });
                    });
                }

                renderNews();
            });
        }

        // Render news list
        function renderNews() {
            const newsList = document.getElementById('newsList');
            newsList.innerHTML = '';

            if (newsData.length === 0) {
                newsList.innerHTML = '<p style="color: #718096; text-align: center; padding: 2rem;">No news articles yet. Click "Add News" to create one.</p>';
                return;
            }

            newsData.forEach((news) => {
                const newsItem = document.createElement('div');
                newsItem.className = 'news-item';
                newsItem.innerHTML = `
                    <div class="news-item-header">
                        <div class="news-headline">${news.headline}</div>
                        <div class="news-date">${news.date}</div>
                    </div>
                    <div class="news-description">${news.description}</div>
                    <div class="news-actions">
                        <button class="btn-edit" onclick="openEditNewsModal('${news.id}')">Edit</button>
                        <button class="btn-delete" onclick="deleteNews('${news.id}')">Delete</button>
                    </div>
                `;
                newsList.appendChild(newsItem);
            });
        }

        // Open modal for adding news
        function openAddNewsModal() {
            currentEditId = null;
            document.getElementById('modalTitle').textContent = 'Add News';
            document.getElementById('newsForm').reset();
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('newsModal').style.display = 'flex';
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('newsDate').value = today;
        }

        // Open modal for editing news
        function openEditNewsModal(newsId) {
            const news = newsData.find(n => n.id === newsId);
            if (!news) return;

            currentEditId = newsId;
            document.getElementById('modalTitle').textContent = 'Edit News';
            document.getElementById('newsHeadline').value = news.headline;
            document.getElementById('newsDate').value = news.date;
            document.getElementById('newsDescription').value = news.description;
            
            const preview = document.getElementById('imagePreview');
            if (news.image) {
                preview.src = news.image;
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }

            document.getElementById('newsModal').style.display = 'flex';
        }

        // Close modal
        function closeNewsModal() {
            document.getElementById('newsModal').style.display = 'none';
            currentEditId = null;
        }

        // Handle form submission
        document.getElementById('newsForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const headline = document.getElementById('newsHeadline').value;
            const date = document.getElementById('newsDate').value;
            const description = document.getElementById('newsDescription').value;
            const imageFile = document.getElementById('newsImage').files[0];

            const newsDataObj = {
                headline,
                date,
                description
            };

            function saveNews(data) {
                if (currentEditId) {
                    // Update existing news
                    database.ref('news/' + currentEditId).update(data)
                        .then(() => {
                            closeNewsModal();
                            fetchStatistics();
                        })
                        .catch((error) => {
                            console.error('Error updating news:', error);
                            alert('Failed to update news. Please try again.');
                        });
                } else {
                    // Add new news
                    const newNewsRef = database.ref('news').push();
                    newNewsRef.set(data)
                        .then(() => {
                            closeNewsModal();
                            fetchStatistics();
                        })
                        .catch((error) => {
                            console.error('Error adding news:', error);
                            alert('Failed to add news. Please try again.');
                        });
                }
            }

            if (imageFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    newsDataObj.image = e.target.result;
                    saveNews(newsDataObj);
                };
                reader.readAsDataURL(imageFile);
            } else if (currentEditId) {
                // Keep existing image if editing and no new image
                const existingNews = newsData.find(n => n.id === currentEditId);
                if (existingNews && existingNews.image) {
                    newsDataObj.image = existingNews.image;
                }
                saveNews(newsDataObj);
            } else {
                saveNews(newsDataObj);
            }
        });

        // Delete news
        function deleteNews(newsId) {
            const news = newsData.find(n => n.id === newsId);
            if (confirm('Are you sure you want to delete this news article?')) {
                database.ref('news/' + newsId).remove()
                    .then(() => {
                        fetchStatistics();
                    })
                    .catch((error) => {
                        console.error('Error deleting news:', error);
                        alert('Failed to delete news. Please try again.');
                    });
            }
        }

        // Image preview
        document.getElementById('newsImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('imagePreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        // Update activity feed (removed - no longer needed)
        function updateActivityFeed() {
            // This function is now handled by buildActivityFeedFromData
        }

        function getActivityIcon(type) {
            switch(type) {
                case 'success': return '‚úì';
                case 'warning': return '‚ö†';
                case 'info': return '‚Ñπ';
                default: return '‚Ä¢';
            }
        }

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                auth.signOut().then(() => {
                    window.location.href = 'Login.html';
                }).catch((error) => {
                    console.error('Logout error:', error);
                    window.location.href = 'Login.html';
                });
            }
        }

        // Show user greeting
        function showUserGreet() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    document.getElementById('userName').textContent = user.email || 'Admin';
                } else {
                    // Fallback to stored user data
                    const storedUser = JSON.parse(localStorage.getItem('user') || '{}');
                    document.getElementById('userName').textContent = storedUser.fullname || 'Admin';
                }
            });
        }

        // Monitor service requests for real-time updates
        function monitorServiceRequests() {
            database.ref('serviceRequestsV2').on('value', (snapshot) => {
                const data = snapshot.val();
                let totalCount = 0;
                let pendingCount = 0;
                let approvedCount = 0;
                let rejectedCount = 0;
                let recentRequestsList = [];
                
                if (data) {
                    Object.entries(data).forEach(([key, req]) => {
                        totalCount++;
                        const status = req.status || 'Pending';
                        if (status === 'Pending') {
                            pendingCount++;
                        } else if (status === 'Approved') {
                            approvedCount++;
                        } else if (status === 'Rejected') {
                            rejectedCount++;
                        }
                        
                        // Track recent requests (last 24 hours)
                        if (req.timestamp) {
                            const requestTime = new Date(req.timestamp);
                            const now = new Date();
                            const hoursDiff = (now - requestTime) / (1000 * 60 * 60);
                            
                            if (hoursDiff < 24) {
                                recentRequestsList.push({
                                    service: req.serviceType || 'Service',
                                    status: status,
                                    time: formatTimeAgo(requestTime)
                                });
                            }
                        }
                    });
                }
                
                document.getElementById('totalRequests').textContent = totalCount;
                document.getElementById('pendingRequests').textContent = pendingCount;
                
                // Build persistent activity feed from actual data
                buildActivityFeedFromData(recentRequestsList, approvedCount, rejectedCount, pendingCount);
            });
        }

        // Build activity feed from real Firebase data
        function buildActivityFeedFromData(recentRequests = [], approvedCount = 0, rejectedCount = 0, pendingCount = 0) {
            const activityFeed = document.getElementById('activityFeed');
            if (!activityFeed) {
                console.warn('buildActivityFeedFromData: #activityFeed not found - skipping render');
                return;
            }

            const activities = [];
            // Add recent individual requests
            (recentRequests || []).slice(0, 5).forEach(req => {
                let type = 'info';
               let icon = '‚Ñπ';
                let message = '';
                if (req.status === 'Approved') { type = 'success'; icon = '‚úì'; message = `${req.service} request approved`; }
               else if (req.status === 'Rejected') { type = 'warning'; icon = '‚úó'; message = `${req.service} request rejected`; }
                else { type = 'info'; icon = 'üìù'; message = `New ${req.service} request received`; }
                activities.push(`
                   <div class="activity-item">
                     <div class="activity-icon ${type}">${icon}</div>
                        <div class="activity-content">
                            <div class="activity-title">${message}</div>
                            <div class="activity-time">${req.time}</div>
                        </div>
                    </div>
                `);
            });

            // Add summary stats
            if (pendingCount > 0) {
               activities.push(`
                   <div class="activity-item">
                        <div class="activity-icon warning">‚è≥</div>
                        <div class="activity-content">
                            <div class="activity-title">${pendingCount} pending request${pendingCount > 1 ? 's' : ''} awaiting review</div>
                            <div class="activity-time">Current status</div>
                        </div>
                    </div>
                `);
            }
            if (approvedCount > 0) {
                activities.push(`
                    <div class="activity-item">
                        <div class="activity-icon success">‚úì</div>
                        <div class="activity-content">
                           <div class="activity-title">${approvedCount} total request${approvedCount > 1 ? 's' : ''} approved</div>
                            <div class="activity-time">All time</div>
                        </div>
                   </div>
                `);
            }

            if (activities.length === 0) {
               activities.push(`
                    <div class="activity-item">
                        <div class="activity-icon info">‚Ñπ</div>
                        <div class="activity-content">
                            <div class="activity-title">No recent activity</div>
                            <div class="activity-time">System running smoothly</div>
                        </div>
                    </div>
                `);
            }

            activityFeed.innerHTML = activities.join('');
        }

        // Format time ago helper
        function formatTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
        }

        // Check URL parameters for filter
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const filter = urlParams.get('filter');
            
            if (filter) {
                // Store the filter preference for when user navigates to AdminServices
                sessionStorage.setItem('serviceFilter', filter);
            }
        }

        // Open user list modal
        function openUserListModal(type) {
            const modal = document.getElementById('userListModal');
            const title = document.getElementById('userListModalTitle');
            const content = document.getElementById('userListContent');
            let users = [];

            if (type === 'nearing18') {
                title.textContent = 'Users Nearing Age 18';
                users = window.nearing18Users || [];
            } else if (type === 'nearingSenior') {
                title.textContent = 'Users Nearing Senior Age';
                users = window.nearingSeniorUsers || [];
            }

            content.innerHTML = users.length
                ? users.map(user => `
                    <li class="user-list-item">
                        <span>${user.fullname || 'Unknown User'}</span>
                        <span>Age: ${user.age || 'N/A'}</span>
                    </li>
                `).join('')
                : '<p style="text-align: center; color: #718096;">No users found.</p>';

            modal.style.display = 'flex';
        }

        // Close user list modal
        function closeUserListModal() {
            document.getElementById('userListModal').style.display = 'none';
        }

        // Archive function
        function archiveRequest(key) {
            const ref = db.ref('serviceRequestsV2/' + key);
            ref.update({ archived: true })
                .then(() => {
                    showToast('Service request archived successfully.', 'success');
                    renderServiceRequests(); // Refresh the list
                })
                .catch((error) => {
                    console.error('Error archiving request:', error);
                    showToast('Failed to archive request. Please try again.', 'error');
                });
        }

        // Export CSV function
        function exportToCSV() {
            const rows = [['Service', 'Resident', 'Contact', 'Date Requested', 'Status']];
            Object.entries(allRequests || {}).forEach(([key, req]) => {
                const { name, contact } = getUserInfo(req.uid);
                rows.push([
                    req.serviceType || '',
                    name || '',
                    contact || '',
                    req.timestamp ? new Date(req.timestamp).toLocaleString() : '',
                    req.status || 'Pending'
                ]);
            });

            const csvContent = rows.map(row => row.map(value => `"${value}"`).join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'service_requests.csv';
            link.click();
            URL.revokeObjectURL(url);
        }

        // Open delete user modal
        function openDeleteUserModal(userId) {
            const modal = document.getElementById('deleteUserModal');
            modal.classList.remove('hidden');
            modal.style.display = 'flex';

            const confirmBtn = document.getElementById('confirmDeleteUserBtn');
            const cancelBtn = document.getElementById('cancelDeleteUserBtn');
            const reasonInput = document.getElementById('deleteReasonInput');

            confirmBtn.onclick = () => {
                const reason = reasonInput.value.trim();
                if (!reason) {
                    showToast('Please provide a reason for deletion.', 'error');
                    return;
                }
                deleteUserAccount(userId, reason);
                modal.classList.add('hidden');
                modal.style.display = 'none';
            };

            cancelBtn.onclick = () => {
                modal.classList.add('hidden');
                modal.style.display = 'none';
            };
        }

        // Delete user account and send email
        function deleteUserAccount(userId, reason) {
            const userRef = db.ref('users/' + userId);
            userRef.once('value').then(snapshot => {
                const user = snapshot.val();
                if (!user || !user.email) {
                    showToast('Failed to find user email.', 'error');
                    return;
                }

                // Send email notification
                sendEmailNotification(user.email, reason)
                    .then(() => {
                        // Remove user from database
                        userRef.remove()
                            .then(() => {
                                showToast('User account deleted successfully.', 'success');
                                renderUsers(); // Refresh the user list
                            })
                            .catch(error => {
                                console.error('Error deleting user:', error);
                                showToast('Failed to delete user. Please try again.', 'error');
                            });
                    })
                    .catch(error => {
                        console.error('Error sending email:', error);
                        showToast('Failed to send email notification.', 'error');
                    });
            });
        }

        // Send email notification
        function sendEmailNotification(email, reason) {
            return fetch('/send-email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    to: email,
                    subject: 'Account Deletion Notification',
                    body: `Your account has been deleted for the following reason: ${reason}`
                })
            });
        }

        // Toast notification helper
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast show ${type}`;
            toast.innerHTML = `
                <div class="toast-icon">${type === 'success' ? '‚úì' : '‚ö†'}</div>
                <div class="toast-message">${message}</div>
            `;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // Initialize on page load
        window.onload = function() {
            fetchNews();
            fetchStatistics();
            monitorServiceRequests();
            checkUrlParams();
        };

        // User Verification Page Script
        async function loadProfiles() {
            const verificationTable = document.getElementById("verificationTable");
            if (!verificationTable) {
                console.warn('loadProfiles: #verificationTable not found in DOM - skipping render');
                return;
            }

            try {
                const snapshot = await database.ref("userVerification").get();
                verificationTable.innerHTML = ""; // Clear existing rows

                if (snapshot && snapshot.exists()) {
                    const users = snapshot.val();
                    Object.values(users).forEach(user => {
                        const row = document.createElement("tr");
                        row.innerHTML = `
                            <td class="border border-gray-200 px-4 py-2">${user.firstname || ''}</td>
                            <td class="border border-gray-200 px-4 py-2">${user.middlename || ''}</td>
                            <td class="border border-gray-200 px-4 py-2">${user.lastname || ''}</td>
                            <td class="border border-gray-200 px-4 py-2">${user.email || ''}</td>
                            <td class="border border-gray-200 px-4 py-2">${user.age || ''}</td>
                            <td class="border border-gray-200 px-4 py-2">${user.sex || ''}</td>
                            <td class="border border-gray-200 px-4 py-2">${user.address || ''}</td>
                            <td class="border border-gray-200 px-4 py-2">${user.phone || ''}</td>
                            <td class="border border-gray-200 px-4 py-2">
                                <a href="${user.barangayIdUrl || '#'}" target="_blank" class="text-orange-500 hover:underline">View ID</a>
                            </td>
                        `;
                        verificationTable.appendChild(row);
                    });
                } else {
                    verificationTable.innerHTML = `<tr><td colspan="9" class="text-center text-gray-500 py-4">No profiles found.</td></tr>`;
                }
            } catch (error) {
                console.error("Error loading profiles:", error);
                verificationTable.innerHTML = `<tr><td colspan="9" class="text-center text-red-500 py-4">Failed to load profiles.</td></tr>`;
            }
       }

        // Only load verification profiles if the table exists on this page
        if (document.getElementById('verificationTable')) {
            loadProfiles();
        }

        // Ensure fetchRecentActivity exists to avoid uncaught ReferenceError from auth handler
         if (typeof fetchRecentActivity !== 'function') {
            function fetchRecentActivity() {
                const feed = document.getElementById('activityFeed');
                if (!feed) {
                    console.warn('fetchRecentActivity: #activityFeed not present - skipping');
                    return;
                }
                try {
                    if (typeof buildActivityFeedFromData === 'function') {
                        buildActivityFeedFromData([], 0, 0, 0);
                        return;
                    }
                   feed.innerHTML = '<div class="activity-item"><div class="activity-icon info">‚Ñπ</div><div class="activity-content"><div class="activity-title">No recent activity</div><div class="activity-time">System running smoothly</div></div></div>';
               } catch (e) {
                    console.warn('fetchRecentActivity fallback failed', e);
                }
            }
        }
    </script>
</body>

</html>
